name: Build and Deploy

on:
  push:
    branches:
      - main
      - beta
  pull_request:
    branches:
      - main
      - beta

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff
      - name: Lint with ruff
        run: ruff check .
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
      - name: Terraform Format Check
        run: terraform fmt -check -recursive
      - name: Terraform Validate
        run: |
          cd terraform
          terraform init -backend=false
          terraform validate

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-asyncio httpx google-cloud-firestore google-cloud-bigquery slack-sdk google-cloud-aiplatform vertexai "mcp[fastapi]" pydantic python-dotenv fastapi starlette google-genai google-cloud-pubsub google-adk pytz pyjwt
          pip install -e ./python/libs/shared
      - name: Run tests
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)/python/libs/shared:$(pwd)/python/services/aibot_logic:$(pwd)/python/services/slack_collector:$(pwd)/python/services/slack_search_mcp
          pytest --ignore=python/tests/integration_test.py

  terraform:
    needs: [lint, test]
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    environment: ${{ (github.ref == 'refs/heads/main' || github.base_ref == 'main') && 'prod' || 'beta' }}
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - uses: actions/checkout@v6
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SA_EMAIL }}
      - name: Get Project Number
        id: project
        run: |
          PROJECT_NUMBER=$(gcloud projects describe ${{ secrets.GCP_PROJECT_ID }} --format='value(projectNumber)')
          echo "::add-mask::$PROJECT_NUMBER"
          echo "number=$PROJECT_NUMBER" >> $GITHUB_OUTPUT
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
      - name: Terraform Init
        run: |
          cd terraform
          terraform init \
            -backend-config="bucket=${{ secrets.GCP_PROJECT_ID }}-aibot-terraform-state" \
            -backend-config="prefix=aibot/terraform/state"
      - name: Terraform Plan
        run: |
          cd terraform
          terraform plan -no-color \
            -var="gcp_gemini_project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var="gcp_gemini_project_number=${{ steps.project.outputs.number }}" \
            -var="gcp_region=${{ secrets.GCP_REGION }}" \
            -var="custom_fqdn=${{ secrets.CUSTOM_FQDN }}" \
            -var="iap_client_id=${{ secrets.IAP_CLIENT_ID }}" \
            -var="iap_client_secret=${{ secrets.IAP_CLIENT_SECRET }}"
      - name: Terraform Apply
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/beta')
        run: |
          cd terraform
          terraform apply -auto-approve \
            -var="gcp_gemini_project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var="gcp_gemini_project_number=${{ steps.project.outputs.number }}" \
            -var="gcp_region=${{ secrets.GCP_REGION }}" \
            -var="custom_fqdn=${{ secrets.CUSTOM_FQDN }}" \
            -var="iap_client_id=${{ secrets.IAP_CLIENT_ID }}" \
            -var="iap_client_secret=${{ secrets.IAP_CLIENT_SECRET }}"

  build-base:
    needs: [lint, test]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/beta')
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'beta' }}
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - uses: actions/checkout@v6
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SA_EMAIL }}
      - name: Configure Docker
        run: gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev --quiet
      - name: Build and Push Base Image
        run: |
          BASE_IMAGE="${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/aibot-images/aibot-base:latest"
          docker build -t $BASE_IMAGE -f python/base.Dockerfile .
          docker push $BASE_IMAGE

  build-and-deploy-services:
    needs: [build-base, terraform]
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'beta' }}
    strategy:
      matrix:
        service: [aibot-logic, slack-collector, slack-search-mcp]
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - uses: actions/checkout@v6
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SA_EMAIL }}
      - name: Configure Docker
        run: gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev --quiet
      - name: Build and Push Service Image
        run: |
          SERVICE_NAME=$(echo "${{ matrix.service }}" | tr '-' '_')
          BASE_IMAGE="${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/aibot-images/aibot-base:latest"
          IMAGE="${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/aibot-images/${{ matrix.service }}:${{ github.sha }}"
          LATEST_IMAGE="${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/aibot-images/${{ matrix.service }}:latest"

          docker build --build-arg SERVICE_NAME=$SERVICE_NAME --build-arg BASE_IMAGE=$BASE_IMAGE -t $IMAGE -f python/Dockerfile .
          docker tag $IMAGE $LATEST_IMAGE
          docker push $IMAGE
          docker push $LATEST_IMAGE
      - name: Deploy Service(s) to Cloud Run
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/beta')
        run: |
          IMAGE="${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/aibot-images/${{ matrix.service }}:${{ github.sha }}"

          # Deploy the primary service assigned to this build
          gcloud run deploy ${{ matrix.service }} \
            --image $IMAGE \
            --region ${{ secrets.GCP_REGION }} \
            --project ${{ secrets.GCP_PROJECT_ID }} \
            --quiet

          # Special case: aibot-logic also powers aibot-webhook
          if [[ "${{ matrix.service }}" == "aibot-logic" ]]; then
            echo "Deploying shard: aibot-webhook using aibot-logic image..."
            gcloud run deploy aibot-webhook \
              --image $IMAGE \
              --region ${{ secrets.GCP_REGION }} \
              --project ${{ secrets.GCP_PROJECT_ID }} \
              --quiet
          fi
