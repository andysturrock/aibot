# Running MCP Bridge in Docker

This document explains how to run the MCP bridge for IAP-protected servers using Docker. This approach ensures all prerequisites (`gcloud` CLI, Python dependencies) are isolated and correctly configured.

## Prerequisites
- **Docker** installed and running.
- **Google Cloud SDK (`gcloud`)** installed and authenticated on the host machine (`gcloud auth login`).

## Build the Image
From the root of the repository, run:
```bash
docker build -t mcp-proxy-bridge -f python/tools/mcp_proxy.Dockerfile .
```

### Custom UID/GID
If your local user ID is not 1000, you should build the image with your specific UID/GID to avoid permission issues when mounting volumes (e.g., your `.cache` or `.config` folders):
```bash
docker build -t mcp-proxy-bridge \
  --build-arg USER_ID=$(id -u) \
  --build-arg GROUP_ID=$(id -g) \
  -f python/tools/mcp_proxy.Dockerfile .
```

## Finding the Connection Details

To configure the bridge, you need several values related to your GCP deployment:

- **`--url`**: The SSE endpoint of your remote MCP server. This is typically the URL of the Load Balancer protecting the service (e.g., `https://aibot.example.com/mcp/sse`).
- **`--project`**: Your GCP Project ID. You can find this by running:
  ```bash
  gcloud config get-value project
  ```
- **`--audience`**: The IAP Client ID for the backend service. This is a stable, unique ID generated by GCP when IAP is first enabled on the resource.
  - **Note on Format**: The audience can be either the OAuth Client ID (e.g., `123456789012-abc123def456.apps.googleusercontent.com`) or the backend service resource path.
    - *Example Resource Path*: `/projects/123456789012/global/backendServices/9876543210987654321`
  - **Option 1: Via Google Cloud Console (Direct)**
    1. Go to **Security > Identity-Aware Proxy** in the GCP Console.
    2. Under the **Resource** column, find your backend service (e.g., `slack-search-mcp-backend`).
    3. Click the three dots (`â‹®`) in the **Actions** column for that resource and select **Get JWT audience code**.
    4. A modal will appear showing code samples. Look for the `client_id` or `audience` value in the displayed snippets. This is your `audience` value.
  - **Option 2: Via CLI (Requires Backend Name)**
    If you see the name of your backend in the **Resource** column, you can use it here:
    ```bash
    gcloud compute backend-services describe <BACKEND_NAME> --global --format='value(iap.oauth2ClientId)'
    ```
    *(Note: Replace `<BACKEND_NAME>` with the exact string from the **Resource** column, such as `slack-search-mcp-backend`)*
- **`--secret-name`**: (Optional) The name of the secret in **Secret Manager** that contains the IAP OAuth credentials (`iapClientId` and `iapClientSecret`).

## Configuration
Add the bridge to your Antigravity configuration (or `mcp_config.json`). Use the command below, replacing the placeholders with your specific details.

### Volumes
- `/path/to/local/gcloud/config`: Usually `~/.config/gcloud`.
- `/path/to/local/token/cache`: A local directory for token persistence (e.g., `~/.cache/mcp-proxy`).

### Parameters
- `--url`: The SSE endpoint of the remote MCP server.
- `--project`: Your GCP Project ID.
- `--audience`: The IAP audience (e.g., `/projects/<PROJECT_NUM>/global/backendServices/<BACKEND_ID>`).
- `--secret-name`: (Optional) The name of a secret in Secret Manager.

### Example Configuration Snippet
```json
{
  "mcpServers": {
    "slack-search-mcp-server": {
      "command": "docker",
      "args": [
        "run",
        "-i",
        "--rm",
        "-v", "<LOCAL_HOME_DIR>/.config/gcloud:/home/mcp/.config/gcloud",
        "-v", "<LOCAL_HOME_DIR>/.cache/mcp-proxy:/home/mcp/.cache/mcp-proxy",
        "mcp-proxy-bridge",
        "--url", "<REMOTE_SSE_URL>",
        "--project", "<GCP_PROJECT_ID>",
        "--audience", "<IAP_AUDIENCE>",
        "--secret-name", "AIBot-shared-config",
        "--skip-alignment"
      ]
    }
  }
}
```

> [!TIP]
> **First Run**: The first time you run the bridge, you may need to perform an interactive login. Run the command manually in your terminal with the `-it` flag:
> ```bash
> docker run -it --rm ... (rest of the args)
> ```
> This will allow you to see the login URL and paste the callback code. Once authenticated, the tokens will be cached and the background `docker run -i` (used by Antigravity) will work seamlessly.

## Troubleshooting
- **Permission Denied**: Ensure the mounted volume for `.config/gcloud` has the correct permissions for the container user (UID 1000 by default).
- **Authentication**: Ensure you have run `gcloud auth login` and `gcloud auth application-default login` on the host machine.
- **Identity Tokens**: If you encounter errors about identity tokens, ensure your account has the `IAP-secured Web App User` role on the target resource.
